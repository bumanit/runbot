<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- TODO: figure out proper keepquery logic -->

    <!-- Basic page layout, this is just assets -->
    <template id="runbot.base_page_new">
        <html t-att-data-bs-theme="theme or 'light'">
            <title t-out="title or 'Runbot'"/>

            <!-- <t t-call-assets="runbot.assets_frontend_new"/> -->
            <!-- <t t-call-assets="web.assets_frontend"/> -->
            <t t-call-assets="runbot.assets_frontend_new"/>

            <t t-if="refresh">
                <!-- TODO: replace this with javascript code -->
                <meta http-equiv="refresh" t-att-content="refresh"/>
            </t>

            <t t-if="not page_info_state or page_info_state == 'ok' or page_info_state not in ('warn', 'ko', 'skipped', 'killed', 'manually_killed')">
                <link rel="icon" type="image/png" href="/runbot/static/src/img/icon_ok.png"/>
                <link rel="icon" type="image/svg+xml" href="/runbot/static/src/img/icon_ok.svg"/>
            </t>
            <t t-elif="page_info_state == 'ko'">
                <link rel="icon" type="image/png" href="/runbot/static/src/img/icon_ko.png"/>
                <link rel="icon" type="image/svg+xml" href="/runbot/static/src/img/icon_ko.svg"/>
            </t>
            <t t-elif="page_info_state == 'warn'">
                <link rel="icon" type="image/png" href="/runbot/static/src/img/icon_warn.png"/>
                <link rel="icon" type="image/svg+xml" href="/runbot/static/src/img/icon_warn.svg"/>
            </t>
            <t t-elif="page_info_state == 'skipped'">
                <link rel="icon" type="image/png" href="/runbot/static/src/img/icon_skipped.png"/>
                <link rel="icon" type="image/svg+xml" href="/runbot/static/src/img/icon_skipped.svg"/>
            </t>
            <t t-elif="page_info_state == 'killed' or page_info_state == 'manually_killed'">
                <link rel="icon" type="image/png" href="/runbot/static/src/img/icon_killed.png"/>
                <link rel="icon" type="image/svg+xml" href="/runbot/static/src/img/icon_killed.svg"/>
            </t>

        </html>
        <body>
            <t t-out="0"/>
        </body>
    </template>

    <template id="runbot.layout_navbar">
        <!-- 
            Context used;
            class Navbar(TypedDict):
                project: self.env['runbot.project']
                projects: Optional[self.env['runbot.project']]
                qu: QueryURL object
                nb_assigned_errors: int
                nb_team_errors: int
                nb_build_errors: int
                has_pr: Optional[bool]
        -->
        <nav class="navbar navbar-expand-sm sticky-top shadow-sm bg-body-tertiary">
            <div class="container-fluid">
                <div class="navbar-brand">
                    <a class="text-reset text-decoration-none text-initial" t-out="project.name" t-att-href="qu('/runbot/%s' % slug(project))"/>
                    <span t-if="projects and len(projects) > 1" class="dropdown-toggle dropdown-toggle-caret d-none d-sm-inline" role="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false"/>
                    <ul t-if="projects and len(projects) > 1" class="dropdown-menu">
                        <li><h6 class="dropdown-header">Change Project</h6></li>
                        <li><a class="dropdown-item active" t-out="project.name" t-att-href="qu('/runbot/%s' % slug(project))"/></li>
                        <li><hr class="dropdown-divider"/></li>
                        <t t-foreach="projects" t-as="_project">
                            <li t-if="project.id != _project.id">
                                <a class="dropdown-item" t-att-href="qu('/runbot/%s' % slug(_project))" t-out="_project.name"/>
                            </li>
                        </t>
                    </ul>
                </div>
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#navbarOffCanvas"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="offcanvas offcanvas-end" tabindex="-1" id="navbarOffCanvas">
                    <div class="offcanvas-header">
                        <h5 class="offcanvas-title" t-out="project.name"/>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="offcanvas"
                            aria-label="Close"
                        />
                    </div>
                    <div class="offcanvas-body">
                        <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                            <li class="nav-item d-sm-none"><a class="nav-link active" aria-current="page" t-att-href="qu('/runbot/%s' % slug(project))" t-out="project.name"/></li>
                            <t t-foreach="projects" t-as="_project">
                                <li t-if="project.id != _project.id" class="nav-item d-sm-none">
                                    <a class="nav-link" t-att-href="qu('/runbot/%s' % slug(_project))" t-out="_project.name"/>
                                </li>
                            </t>
                            <!-- TODO: js code to open preferences -->
                            <li class="nav-item divider"/>
                            <li class="nav-item"><a class="o_runbot_preferences nav-link" href="#"><i class="fa fa-gear"/></a></li>
                                <li class="nav-item divider"/>
                            <t t-if="not user_id._is_public()">
                                <li class="nav-item" t-if="nb_assigned_errors">
                                    <a href="/runbot/errors" class="nav-link text-danger" t-attf-title="You have {{nb_assigned_errors}} random bug assigned">
                                        <i class="fa fa-bug"/>
                                        <t t-out="nb_assigned_errors"/>
                                        <span class="text-warning" t-if="nb_team_errors" t-out="'+ ' + nb_team_errors"/>
                                    </a>
                                </li>
                                <li class="nav-item" t-elif="nb_team_errors">
                                    <a href="/runbot/errors" class="nav-link text-warning" t-attf-title="Your team has {{nb_team_errors}} random bug assigned">
                                        <i class="fa fa-bug"/>
                                        <t t-out="nb_team_errors"/>
                                    </a>
                                </li>
                                <li class="nav-item" t-elif="nb_build_errors">
                                    <a href="/runbot/errors" class="nav-link" title="Random Bugs"><i class="fa fa-bug"/></a>
                                </li>
                                <li class="nav-item dropdown" t-ignore="true">
                                    <a href="#" class="o_runbot_navbar_username nav-link fw-bold text-truncate" data-bs-toggle="dropdown" t-out="user_id.name"/>
                                    <div class="dropdown-menu dropdown-menu-end" role="menu">
                                        <a class="dropdown-item" id="o_logout" role="menuitem" t-attf-href="/web/session/logout?redirect=/">Logout</a>
                                        <a class="dropdown-item" role="menuitem" t-attf-href="/web">Web</a>
                                        <div t-if="user_id.runbot_team_ids" class="dropdown-divider"/>
                                        <div t-if="user_id.runbot_team_ids" class="dropdown-header">Teams</div>
                                        <a t-foreach="user_id.runbot_team_ids" t-as="team" class="dropdown-item" role="menuitem" t-attf-href="/runbot/teams/{{team.id}}">
                                            <t t-out="team.name.capitalize()"/>
                                        </a>
                                    </div>
                                </li>
                            </t>
                            <li class="nav-item" t-else="" t-ignore="true">
                                <a class="nav-link fw-bold" t-attf-href="/web/login?redirect={{request.httprequest.path}}">Login</a>
                            </li>
                            <li class="nav-item">
                                <div class="btn-group" role="group">
                                    <a class="btn btn-outline-secondary" onclick="legacy()">a</a>
                                    <a class="btn btn-outline-secondary" onclick="light()">b</a>
                                    <a class="btn btn-outline-secondary" onclick="dark()">c</a>
                                    <a class="btn btn-outline-secondary" onclick="red404()">d</a>
                                </div>
                            </li>
                        </ul>
                        <form class="mt-3 mb-0 mt-sm-0 d-flex">
                            <!-- TODO: style -> has pr button shows as primary if input is checked-->
                            <div class="input-group me-2 flex-grow-1">
                                <input class="form-control" type="search" name="search" placeholder="Search" aria-label="Search"/>
                            </div>
                            <div class="btn-group">
                                <div class="input-group-text o_runbot_btn_haspr btn btn-outline-primary p-0" type="button" tabindex="0">
                                    <!-- TODO: js component -->
                                    <input type="checkbox" tabindex="0" id="searchHasPr" name="has_pr" class="d-none" t-att-checked="bool(request.params.get('has_pr'))"></input>
                                    <label for="searchHasPr" class="py-2 px-3 w-100 h-100 align-content-center" role="button">
                                        <i class="fa fa-github"></i>
                                    </label>
                                </div>
                                <button class="btn btn-outline-success" type="submit">Search</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </nav>
    </template>

    <template id="runbot.layout_toolbar_start_section">
        <div t-if="toolbar.get('breadcrumbs') and len(toolbar.get('breadcrumbs')) > 1" class="o_runbot_toolbar_breadcrumbs d-flex">
            <t t-set="breadcrumbs" t-value="toolbar.get('breadcrumbs')"/>
            <ol class="breadcrumb flex-nowrap text-nowrap lh-sm">
                <li
                    t-foreach="breadcrumbs" t-as="breadcrumb"
                    t-attf-class="breadcrumb-item d-inline-flex{{' active' if breadcrumb == breadcrumbs[-1] else None}}"
                    t-att-aria-current="'page' if breadcrumb == breadcrumbs[-1] else None"
                >
                    <a t-if="breadcrumb != breadcrumbs[-1]" t-att-href="breadcrumb.url" t-out="breadcrumb.name"/>
                    <t t-else="" t-out="breadcrumb.name"/>
                </li>
            </ol>
        </div>
    </template>

    <template id="runbot.layout_toolbar_middle_section">
        <div t-if="toolbar.get('message')" class="alert alert-warning m-0" role="alert" t-out="toolbar.get('message')"/>
    </template>

    <template id="runbot.layout_toolbar_end_section">
        <a t-if="toolbar.get('pending_count')" href="/runbot/load_info" class="text-decoration-none">
            <span t-attf-class="badge text-bg-{{toolbar.get('pending_level')}}">
                Pending: <t t-out="toolbar.get('pending_count')"/>
                <span t-if="toolbar.get('pending_assigned_count')" title="Assigned build (reserved host)">
                    (<t t-out="toolbar.get('pending_assigned_count')"/>)
                </span>
            </span>
        </a>
        <a href="/runbot/load_info" t-if="toolbar.get('hosts_data') is not None" class="slots_infos text-decoration-none">
            <t t-set="testing" t-value="toolbar.get('hosts_data')._total_testing()"/>
            <t t-set="workers" t-value="toolbar.get('hosts_data')._total_workers()"/>
            <t t-set="klass">success</t>
            <t t-if="not workers" t-set="klass">danger</t>
            <t t-else="">
                <t t-if="int(testing)/workers > 0" t-set="klass">info</t>
                <t t-if="int(testing)/workers > 0.75" t-set="klass">warning</t>
                <t t-if="int(testing)/workers >= 1" t-set="klass">danger</t>
            </t>
            <span t-attf-class="badge text-bg-{{klass}}">
                Testing:
                <t t-out="testing"/>
                /
                <t t-out="workers"/>
            </span>
        </a>
    </template>

    <template id="runbot.layout_toolbar">
        <t t-set="toolbar" t-value="toolbar or {}"/>
        <!-- TODO: js code to have top value take the height of the navbar -->
        <div t-att-class="'o_runbot_toolbar row bg-body' + (' position-sticky z-1' if toolbar.get('sticky', True) else '')">
            <div class="d-flex flex-wrap flex-md-nowrap justify-content-between align-items-center gap-md-3">
                <!-- Toolbar is made of left middle and right part -->
                <div class="d-flex d-empty-none order-0" style="flex: 1;">
                    <t t-call="{{toolbar.get('start_template', 'runbot.layout_toolbar_start_section')}}"/>
                </div>
                <div class="d-flex d-empty-none justify-content-start justify-content-md-around order-2 order-md-1 w-100 w-md-auto mw-100" style="flex: 1;">
                    <t t-call="{{toolbar.get('middle_template', 'runbot.layout_toolbar_middle_section')}}"/>
                </div>
                <div class="d-flex d-empty-none justify-content-end order-1 order-md-2 flex-grow-1 gap-1" style="flex: 1;">
                    <t t-call="{{toolbar.get('end_template', 'runbot.layout_toolbar_end_section')}}"/>
                </div>
            </div>
        </div>
    </template>

    <template id="runbot.layout_new">
        <t t-call="runbot.base_page_new">
            <t t-call="{{layout_nav_template or 'runbot.layout_navbar'}}"/>
            <div class="container-fluid o_runbot_main_container d-flex flex-column">
                <t t-call="{{layout_nav_toolbar or 'runbot.layout_toolbar'}}"/>
                <t t-out="0"/>
            </div>
        </t>
    </template>
</odoo>
